#!/bin/sh

set -e
set -u

TIMESTAMP=$(date -u -Iseconds | sed "s|+00:00|z|")
HASH=$(git rev-parse --short HEAD)
VENDOR="hugoguru"

# Prepare `ldflags` argument
LDFLAGS="-s -w"
LDFLAGS="$LDFLAGS -X github.com/gohugoio/hugo/common/hugo.buildDate=${TIMESTAMP}"
LDFLAGS="$LDFLAGS -X github.com/gohugoio/hugo/common/hugo.commitHash=${HASH}"
test ! "${HUGO_VENDOR:-}" || LDFLAGS="$LDFLAGS -X github.com/gohugoio/hugo/common/hugo.vendorInfo=${HUGO_VENDOR}"

# Prepare tags
if [ "$HUGO_TYPE" = "standard" ]; then
    TAGS=""
elif [ "$HUGO_TYPE" = "extended" ]; then
    TAGS="--tags extended"
else
    echo "Unknown Hugo type"
    exit 1
fi

export CGO_ENABLED=1

# Create output folder
mkdir -p /work/target/bundle

# Compile Hugo
go build -o /work/target/bundle/hugo $TAGS -ldflags="$LDFLAGS"

# Run Hugo
/work/target/bundle/hugo version
